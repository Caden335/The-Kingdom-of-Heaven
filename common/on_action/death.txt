# character just about to die in root scope
# if a killer is know, it's set as scope:killer
#Triggered by code

on_death = {
	effect = {
	
		save_temporary_scope_as = root_character
		if = {
			limit = {
				exists = scope:killer
			}
			if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_1 }
				}
				scope:killer = { set_variable = has_artifact_1 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_2 }
				}
				scope:killer = { set_variable = has_artifact_2 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_3 }
				}
				scope:killer = { set_variable = has_artifact_3 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_4 }
				}
				scope:killer = { set_variable = has_artifact_4 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_5 }
				}
				scope:killer = { set_variable = has_artifact_5 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_6 }
				}
				scope:killer = { set_variable = has_artifact_6 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_7 }
				}
				scope:killer = { set_variable = has_artifact_7 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_8 }
				}
				scope:killer = { set_variable = has_artifact_8 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_9 }
				}
				scope:killer = { set_variable = has_artifact_9 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_10 }
				}
				scope:killer = { set_variable = has_artifact_10 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_11 }
				}
				scope:killer = { set_variable = has_artifact_11 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_12 }
				}
				scope:killer = { set_variable = has_artifact_12 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_13 }
				}
				scope:killer = { set_variable = has_artifact_13 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_14 }
				}
				scope:killer = { set_variable = has_artifact_14 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_15 }
				}
				scope:killer = { set_variable = has_artifact_15 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_16 }
				}
				scope:killer = { set_variable = has_artifact_16 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_17 }
				}
				scope:killer = { set_variable = has_artifact_17 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_18 }
				}
				scope:killer = { set_variable = has_artifact_18 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_19 }
				}
				scope:killer = { set_variable = has_artifact_19 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_20 }
				}
				scope:killer = { set_variable = has_artifact_20 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_21 }
				}
				scope:killer = { set_variable = has_artifact_21 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_22 }
				}
				scope:killer = { set_variable = has_artifact_22 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_23 }
				}
				scope:killer = { set_variable = has_artifact_23 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_24 }
				}
				scope:killer = { set_variable = has_artifact_24 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_25 }
				}
				scope:killer = { set_variable = has_artifact_25 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_26 }
				}
				scope:killer = { set_variable = has_artifact_26 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_27 }
				}
				scope:killer = { set_variable = has_artifact_28 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_29 }
				}
				scope:killer = { set_variable = has_artifact_29 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_30 }
				}
				scope:killer = { set_variable = has_artifact_30 }
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_31 }
				}
				scope:killer = { set_variable = has_artifact_31 }
			}
			clear_all_artifacts_death = yes
		}
		else_if = {
			limit = {
				any_close_or_extended_family_member = {
					is_primary_heir_of = scope:root_character
				}
			}
			every_close_or_extended_family_member = {
				limit = {
					is_primary_heir_of = scope:root_character
				}
				save_scope_as = primary_heir
			}
			if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_1 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_1
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_2 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_2
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_3 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_3
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_4 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_4
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_5 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_5
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_6 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_6
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_7 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_7
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_8 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_8
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_9 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_9
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_10 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_10
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_11 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_11
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_12 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_12
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_13 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_13
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_14 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_14
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_15 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_15
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_16 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_16
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_17 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_17
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_18 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_18
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_19 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_19
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_20 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_20
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_21 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_21
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_22 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_22
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_23 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_23
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_24 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_24
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_25 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_25
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_26 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_26
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_27 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_27
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_28 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_28
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_29 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_29
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_30 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_30
					}
				}
			}
			else_if = {
				limit = {
					scope:root_character = { has_variable = has_artifact_31 }
				}
				random = {
					chance = 90
					scope:primary_heir = {
						set_variable = has_artifact_31
					}
				}
			}
			clear_all_artifacts_death = yes
		}
		else = {
			clear_all_artifacts_death = yes
		}
	
		play_music_cue = "mx_cue_death"
		every_parent = {
			sound_foundations_random_removal_effect = yes
		}
		if = {
			limit = {
				is_ai = no
				exists = player_heir
			}
			player_heir = {
				add_character_flag = {
					flag = tutorial_reactive_advice_succession
				}
			}
		}
		if = {
			limit = {
				exists = global_var:mongol_empire_was_broken_up
				exists = global_var:handed_out_mongolia_in_mongol_succession # If Mongolia wasn't properly granted, something has gone wrong, and the primary_heir should receive the Mongol Empire as expected
				any_held_title = {
					this = title:e_mongol_empire
				}
			}
			destroy_title = title:e_mongol_empire
		}

		invalidate_claimant_factions_on_death_effect = yes
	}
	events = {
		death_management.0096	# Updates marriage opinions of other spouses if relevant.
		death_management.0097	# Sets a flag if the dead one was someone you loved (to make suicide available)
		death_management.0098 	# Removes rejected_from_marriage_bed_modifier if spouse dies
		death_management.0099 	# If spouse is pregnant, save as variable
		death_management.0001 	# Finds characters which would care about death for notifications etc.
		intrigue_dread.4012		# Interrupts this event chain for the imprisoner when their prisoner dies.
		stewardship_duty.1065 	# Removes the patron buff from their employer when this character dies.
		stewardship_duty.1067 	# When you die removes your clients fron your court.
		great_holy_war.0024		# Replace recipient for ongoing GHW.
		great_holy_war.0028 	# Beneficiary died, reset and replace.
		great_holy_war.0080 	# ghw_sponsor died, replace.
		great_holy_war.0083		# ghw fallback beneficiary dies.
		religious_decision.0301 # ancestor died and needs to be buried.
		religious_decision.0311 # Dynasty member has died and you can raise a runestone
		game_rule.2				# Exclave Independence
		martial_authority.2057	# Right-Hand Person Dies 
		martial_authority.2055  # Right-handed Person (person with right-hand) Died
	}
}

# Root = character
# Triggered when someone is about to die from a natural death but is given a second chance by meeting
# the has_natural_death_second_chance scripted rule
on_natural_death_second_chance = {
	effect = {
		add_character_flag = {
			flag = know_thyself_perk_delay_period
			days = 390
		}
		add_character_flag = know_thyself_has_triggered_delay
		trigger_event = death_management.9998
		trigger_event = {
			id = death_management.9999
			days = { 340 380 }
		}
	}
}